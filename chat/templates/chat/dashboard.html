<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Connect</title>
    
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" href="/static/images/logo_192.png">
    <meta name="theme-color" content="#1e1b4b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; background: #fff; }
        
        #app-layout { display: flex; height: 100vh; width: 100vw; }
        
        /* COL 1: DESKTOP NAV */
        #col-nav { width: 80px; background: #1e1b4b; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; z-index: 50; }

        /* COL 2: LIST */
        #col-list { width: 350px; background: #ffffff; border-right: 1px solid #f3f4f6; display: flex; flex-direction: column; position: relative; resize: horizontal; overflow: hidden; min-width: 300px; max-width: 500px; }

        /* COL 3: MAIN STAGE */
        #col-stage { flex: 1; background: #f3f4f6; position: relative; display: flex; flex-direction: column; min-width: 0; }

        /* MOBILE OVERRIDES */
        @media (max-width: 768px) {
            #col-nav { display: none; } 
            #col-list { width: 100% !important; border: none; resize: none; }
            #col-stage { width: 100%; display: none; z-index: 100; position: fixed; top: 0; left: 0; height: 100%; }
            
            body.chat-open #col-list { display: none; }
            body.chat-open #col-stage { display: flex; }
        }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .nav-active { background-color: #4f46e5; color: white; border-radius: 12px; }
    </style>
</head>
<body id="body">

    <div id="app-layout">
        
        <nav id="col-nav" class="py-6 shadow-xl hidden md:flex">
            <div class="mb-10 p-1">
                <img src="/static/images/logo_192.png" class="w-10 h-10 rounded-lg shadow-lg opacity-90">
            </div>
            
            <div class="space-y-6 flex-1 w-full flex flex-col items-center">
                <div class="w-12 h-12 flex items-center justify-center text-indigo-300 hover:text-white cursor-pointer transition nav-active" 
                     onclick="switchTab(this)" hx-get="{% url 'list_chats' %}" hx-target="#list-content">
                    <i class="fas fa-comment-alt text-xl"></i>
                </div>
                <div class="w-12 h-12 flex items-center justify-center text-indigo-300 hover:text-white cursor-pointer transition" 
                     onclick="switchTab(this)" hx-get="{% url 'channels_page' %}" hx-target="#main-panel">
                    <i class="fas fa-bullhorn text-xl"></i>
                </div>
                <div class="w-12 h-12 flex items-center justify-center text-indigo-300 hover:text-white cursor-pointer transition" 
                     onclick="switchTab(this)" hx-get="{% url 'calls_page' %}" hx-target="#main-panel">
                    <i class="fas fa-phone-alt text-xl"></i>
                </div>
            </div>

            <div class="mb-4">
                <div class="w-10 h-10 rounded-full border-2 border-indigo-500/50 cursor-pointer overflow-hidden hover:scale-105 transition"
                     hx-get="{% url 'settings_page' %}" hx-target="#main-panel" onclick="openMobileStage()">
                    <img src="https://ui-avatars.com/api/?name={{ request.user.username }}" class="w-full h-full object-cover">
                </div>
            </div>
        </nav>

        <aside id="col-list">
            <div class="h-16 flex items-center justify-between px-4 border-b border-gray-100 bg-white flex-shrink-0">
                <button class="md:hidden text-gray-600 p-2" onclick="document.getElementById('mobile-drawer').classList.remove('-translate-x-full')">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">P2P Connect</h1>
                <button onclick="toggleSearch()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div id="search-container" class="hidden px-4 mb-2 transition-all">
                <input type="text" name="search" placeholder="Search chats..." 
                       class="w-full bg-gray-100 rounded-lg py-2 px-4 text-sm outline-none focus:ring-2 focus:ring-indigo-100"
                       hx-get="{% url 'list_chats' %}" hx-target="#list-content" hx-trigger="keyup changed delay:500ms">
            </div>

            <div id="list-content" class="flex-1 overflow-y-auto hide-scroll p-2">
                {% include 'chat/partials/list_chats.html' %}
            </div>

            <button onclick="htmx.ajax('GET', '{% url 'contacts_page' %}', '#main-panel'); openMobileStage()" 
                    class="absolute bottom-20 md:bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center text-xl z-30 hover:scale-105 transition hover:shadow-indigo-300">
                <i class="fas fa-plus"></i>
            </button>

            <div class="md:hidden h-16 border-t border-gray-100 flex justify-around items-center bg-white z-20 flex-shrink-0">
                <button class="text-indigo-600 flex flex-col items-center" onclick="switchTabMobile(this)" hx-get="{% url 'list_chats' %}" hx-target="#list-content">
                    <i class="fas fa-comment-alt text-lg"></i><span class="text-[10px]">Chats</span>
                </button>
                <button class="text-gray-400 flex flex-col items-center" onclick="switchTabMobile(this)" hx-get="{% url 'status_page' %}" hx-target="#main-panel">
                    <i class="far fa-dot-circle text-lg"></i><span class="text-[10px]">Status</span>
                </button>
                <button class="text-gray-400 flex flex-col items-center" onclick="switchTabMobile(this)" hx-get="{% url 'calls_page' %}" hx-target="#main-panel">
                    <i class="fas fa-phone-alt text-lg"></i><span class="text-[10px]">Calls</span>
                </button>
            </div>
        </aside>

        <main id="col-stage">
            <div id="main-panel" class="h-full flex flex-col relative bg-gray-50 w-full">
                <div class="flex-1 flex flex-col items-center justify-center text-gray-400">
                    <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-4 animate-pulse">
                        <img src="/static/images/logo_192.png" class="w-10 h-10 opacity-50">
                    </div>
                    <p class="text-sm">Select a chat to start messaging.</p>
                </div>
            </div>
        </main>

        <div id="mobile-drawer" class="fixed inset-0 z-[150] bg-black/50 hidden md:hidden" onclick="this.classList.add('hidden')">
            <div class="w-72 h-full bg-white shadow-xl flex flex-col" onclick="event.stopPropagation()">
                <div class="p-6 bg-[#1e1b4b] text-white">
                    <h2 class="font-bold text-lg">{{ request.user.username }}</h2>
                    <p class="text-xs text-indigo-200">{{ request.user.mobile }}</p>
                </div>
                <div class="p-4">
                    <button onclick="openMobileStage(); htmx.ajax('GET', '{% url 'settings_page' %}', '#main-panel')" 
                            class="w-full text-left p-3 rounded-lg hover:bg-gray-50 flex items-center">
                        <i class="fas fa-cog w-6 text-gray-400"></i> Settings
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        function openMobileStage() { if(window.innerWidth < 768) document.body.classList.add('chat-open'); }
        function closeMobileStage() { document.body.classList.remove('chat-open'); }
        function toggleSearch() { 
            const bar = document.getElementById('search-container');
            bar.classList.toggle('hidden');
            if(!bar.classList.contains('hidden')) bar.querySelector('input').focus();
        }
        function switchTab(el) { 
            document.querySelectorAll('#col-nav div').forEach(d => d.classList.remove('nav-active')); 
            el.classList.add('nav-active'); 
        }
        function switchTabMobile(el) {
            document.querySelectorAll('.md\\:hidden button').forEach(b => { 
                b.classList.remove('text-indigo-600'); b.classList.add('text-gray-400'); 
            });
            el.classList.remove('text-gray-400'); el.classList.add('text-indigo-600');
        }
        
        // Mobile Back Button Logic
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'main-panel' && window.innerWidth < 768) {
                openMobileStage();
            }
        });
        
        // --- WebSockets ---
        let chatSocket = null;
        window.initChat = function(roomId, userId) {
            if (chatSocket) chatSocket.close();
            const wsUrl = `ws://${window.location.host}/ws/chat/${roomId}/`;
            chatSocket = new WebSocket(wsUrl);
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                if(typeof appendMessage === 'function') appendMessage(data.message, data.user_id, userId);
            };
        };
        window.sendMessage = function() {
            const input = document.getElementById('chat-input');
            if (input && input.value.trim() && chatSocket) {
                chatSocket.send(JSON.stringify({ 'message': input.value.trim(), 'user_id': "{{ request.user.id }}" }));
                input.value = '';
            }
        };
    </script>
</body>
</html>