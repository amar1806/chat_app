<div class="flex flex-col h-full w-full bg-[#efeae2] relative animate-fade-in group font-sans" onclick="handleGlobalClick(event)">
    
    <!-- Multi-Select Toolbar -->
    <div id="multi-select-toolbar" class="hidden bg-indigo-600 text-white px-3 md:px-6 py-3 flex items-center justify-between z-20 shadow-lg animate-slide-down">
        <div class="flex items-center gap-3">
            <span id="selected-count" class="font-bold">0 selected</span>
            <button onclick="clearSelection()" class="text-sm hover:bg-indigo-500 px-2 py-1 rounded transition">Clear</button>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="openForwardDialog()" class="p-2 hover:bg-indigo-500 rounded transition" title="Forward selected">
                <i class="fas fa-share"></i>
            </button>
        </div>
    </div>
<script>
            let selectedMessages = new Set();
            let touchStartX = 0;
            let touchStartY = 0;

            function updateSelectionUI() {
                const toolbar = document.getElementById('multi-select-toolbar');
                const count = selectedMessages.size;
                if (count > 0) {
                    toolbar.classList.remove('hidden');
                    document.getElementById('selected-count').textContent = `${count} selected`;
                } else {
                    toolbar.classList.add('hidden');
                }
            }

            function clearSelection() {
                selectedMessages.forEach(msgId => {
                    const msgElement = document.getElementById(`msg-${msgId}`);
                    if (msgElement) msgElement.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
                });
                selectedMessages.clear();
                updateSelectionUI();
                closeAllMenus();
            }

            function startLongPress(event, msgId, senderId, currentUserId) {
                if (window.innerWidth >= 768) return; // desktop uses right-click
                const touch = event.touches && event.touches[0];
                if (touch) { touchStartX = touch.clientX; touchStartY = touch.clientY; }
                longPressTimer = setTimeout(() => showMobileMenu(event, msgId, senderId, currentUserId), 500);
            }

            function cancelLongPress() { clearTimeout(longPressTimer); }

            // Swipe-to-Reply (mobile) - detect left swipe
            function handleTouchMove(event, msgId, senderId, currentUserId) {
                const touch = event.touches && event.touches[0];
                if (!touch) return;
                const touchEndX = touch.clientX, touchEndY = touch.clientY;
                const horizontal = touchStartX - touchEndX; // left swipe positive
                const verticalDistance = Math.abs(touchEndY - touchStartY);
                // left swipe threshold 50px, ignore large vertical movement
                if (horizontal > 50 && verticalDistance < 30) {
                    clearTimeout(longPressTimer);
                    const msgElement = document.getElementById(`msg-${msgId}`);
                    if (msgElement) {
                        msgElement.style.transform = 'translateX(-8px)';
                        setTimeout(() => { msgElement.style.transform = 'translateX(0)'; }, 180);
                        // set reply using message text
                        setReply(msgId, msgElement.getAttribute('data-message-text'));
                        showToast('‚Ü©Ô∏è Reply mode activated', 'blue');
                    }
                }
            }

            function showContextMenu(event, msgId, senderId, currentUserId) {
                event.preventDefault();
                closeAllMenus();
                const msgElement = document.getElementById(`msg-${msgId}`);
                if (!msgElement) return;

                const menu = document.createElement('div');
                menu.className = 'fixed bg-white rounded-lg shadow-xl border border-gray-200 z-50 animate-fade-in popup-menu';
                menu.id = 'context-menu';

                const isOwner = senderId == currentUserId;
                const msgText = msgElement.getAttribute('data-message-text') || '';

                menu.innerHTML = `
                    <div class="py-2 min-w-max">
                        <button onclick="toggleSelectMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-check-square text-indigo-600 w-4"></i> Select</button>
                        <button onclick="copyMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-copy text-blue-600 w-4"></i> Copy</button>
                        <button onclick="setReply('${msgId}', '${msgText.replace(/'/g, "\\'")}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-reply text-green-600 w-4"></i> Reply</button>
                        <button onclick="showSimpleInfo('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-info-circle text-blue-600 w-4"></i> Info</button>
                        <button onclick="pinMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-thumbtack text-amber-600 w-4"></i> Pin</button>
                        <button onclick="forwardMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-share text-green-600 w-4"></i> Forward</button>
                        ${isOwner ? `\n                <div class="border-t border-gray-200 my-1"></div>\n                <button onclick="deleteMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"><i class="fas fa-trash w-4"></i> Delete</button>\n                ` : ''}
                    </div>`;

                document.body.appendChild(menu);

                // Position menu: prefer near mouse, but keep inside viewport and above if at bottom
                const rect = menu.getBoundingClientRect();
                let left = event.clientX;
                let top = event.clientY;
                // adjust horizontal overflow
                if (left + rect.width + 10 > window.innerWidth) left = Math.max(10, window.innerWidth - rect.width - 10);
                // adjust vertical overflow: if menu would go below viewport, show above
                if (top + rect.height + 10 > window.innerHeight) top = Math.max(10, event.clientY - rect.height - 10);
                menu.style.left = left + 'px';
                menu.style.top = top + 'px';

                setTimeout(() => { document.addEventListener('click', closeContextMenu); }, 0);
            }

            function showMobileMenu(event, msgId, senderId, currentUserId) {
                const msgElement = document.getElementById(`msg-${msgId}`);
                if (!msgElement) return;

                const menu = document.createElement('div');
                menu.className = 'fixed bg-white rounded-lg shadow-xl border border-gray-200 z-50 animate-slide-up popup-menu';
                menu.id = 'mobile-menu';

                const isOwner = senderId == currentUserId;
                const msgText = msgElement.getAttribute('data-message-text') || '';
                menu.innerHTML = `
                    <div class="py-2 min-w-max">
                        <button onclick="toggleSelectMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-check-square text-indigo-600 w-4"></i> Select</button>
                        <button onclick="copyMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-copy text-blue-600 w-4"></i> Copy</button>
                        <button onclick="setReply('${msgId}', '${msgText.replace(/'/g, "\\'")}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-reply text-green-600 w-4"></i> Reply</button>
                        <button onclick="showSimpleInfo('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-info-circle text-blue-600 w-4"></i> Info</button>
                        <button onclick="pinMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-thumbtack text-amber-600 w-4"></i> Pin</button>
                        <button onclick="forwardMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2"><i class="fas fa-share text-green-600 w-4"></i> Forward</button>
                        ${isOwner ? `\n                <div class="border-t border-gray-200 my-1"></div>\n                <button onclick="deleteMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"><i class="fas fa-trash w-4"></i> Delete</button>\n                ` : ''}
                    </div>`;

                document.body.appendChild(menu);

                // Position: if near bottom, show above message; else show centered near bottom
                const msgRect = msgElement.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();
                if (msgRect.bottom + menuRect.height + 20 > window.innerHeight) {
                    // show above message
                    const top = Math.max(10, msgRect.top - menuRect.height - 8);
                    menu.style.top = top + 'px';
                    menu.style.left = Math.min(window.innerWidth - menuRect.width - 10, Math.max(10, msgRect.left + (msgRect.width/2) - (menuRect.width/2))) + 'px';
                } else {
                    menu.style.bottom = '100px';
                    menu.style.left = '50%';
                    menu.style.transform = 'translateX(-50%)';
                    menu.style.maxWidth = '85vw';
                }

                setTimeout(() => { document.addEventListener('click', closeMobileMenu); }, 0);
            }

            function closeContextMenu() { const menu = document.getElementById('context-menu'); if (menu) menu.remove(); document.removeEventListener('click', closeContextMenu); }
            function closeMobileMenu() { const menu = document.getElementById('mobile-menu'); if (menu) menu.remove(); document.removeEventListener('click', closeMobileMenu); }
            function closeAllMenus() { closeContextMenu(); closeMobileMenu(); }

            function toggleSelectMessage(msgId) {
                const msgElement = document.getElementById(`msg-${msgId}`);
                if (!msgElement) return;
                if (selectedMessages.has(msgId)) { selectedMessages.delete(msgId); msgElement.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50'); }
                else { selectedMessages.add(msgId); msgElement.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50'); }
                updateSelectionUI(); closeAllMenus();
            }

            function copyMessage(msgId) {
                const msgElement = document.getElementById(`msg-${msgId}`); if (!msgElement) return; const msgText = msgElement.getAttribute('data-message-text'); if (!msgText) return;
                navigator.clipboard.writeText(msgText).then(() => { showToast('‚úì Message copied to clipboard', 'green'); closeAllMenus(); }).catch(() => { showToast('‚ùå Failed to copy message', 'red'); });
            }

            // keep deleteConversation, deleteSelectedMessages, forward helpers as-is (existing functions remain)

            // Rebind swipe listeners using data attributes (safer)
            document.querySelectorAll('.message-item').forEach(item => {
                const msgId = item.getAttribute('data-message-id');
                const senderId = item.getAttribute('data-sender-id');
                const currentUserId = "{{ request.user.id }}";
                item.addEventListener('touchmove', (e) => handleTouchMove(e, msgId, senderId, currentUserId), { passive: true });
                item.addEventListener('touchend', cancelLongPress, { passive: true });
                item.addEventListener('touchstart', (e) => { const t = e.touches && e.touches[0]; if (t) { touchStartX = t.clientX; touchStartY = t.clientY; } }, { passive: true });
            });

            // Fetch manifest.json and populate app name/icon where possible
            {% verbatim %}(function loadAppManifest(){
                fetch('/static/manifest.json').then(res => res.json()).then(manifest => {
                    const appName = manifest.name || manifest.short_name || 'App';
                    let icon = '/static/images/logo_192.png';
                    if (manifest.icons && manifest.icons.length) icon = manifest.icons[0].src || icon;
                    if (manifest.icon) icon = manifest.icon;

                    // Replace any title that says 'Chats'
                    document.querySelectorAll('h1, h2, .page-title, .title, .chats-title, #chats-title').forEach(el => {
                        if (el.textContent && el.textContent.trim() === 'Chats') el.textContent = appName;
                    });

                    // Place app name in mobile header placeholders
                    document.querySelectorAll('#mobile-app-name, .mobile-app-name').forEach(el => el.textContent = appName);

                    // Replace sidebar placeholder icon if present
                    const sidebarIconPlaceholder = document.querySelector('#sidebar-app-icon, .sidebar-app-icon, [data-replace-with-app-icon="true"]');
                    if (sidebarIconPlaceholder) {
                        sidebarIconPlaceholder.innerHTML = `<img src="${icon}" alt="${appName}" class="w-10 h-10 rounded-full object-cover">`;
                    }

                    // Also set any element with id app-name
                    document.querySelectorAll('#app-name, .app-name').forEach(el => el.textContent = appName);
                }).catch(() => {/* ignore safely */});
            })();{% endverbatim %}

            // Global click handler for menus
            document.addEventListener('click', handleGlobalClick);
    }

    function startVideoCall(userId, username) {
        const message = `üìπ Incoming video call from ${window.currentUsername || 'Unknown'}`;
        alert(`Starting video call with ${username}...`);
        if (window.chatSocket && window.chatSocket.readyState === WebSocket.OPEN) {
            window.chatSocket.send(JSON.stringify({
                'type': 'call_signal',
                'user_id': "{{ request.user.id }}",
                'signal_type': 'call_initiate',
                'payload': {
                    'callType': 'video',
                    'callerId': "{{ request.user.id }}",
                    'callerName': "{{ request.user.username }}"
                }
            }));
        }
    }

    // 9. MESSAGE ACTIONS - Context Menu (Desktop) & Long Press (Mobile) with Swipe-to-Reply
    let longPressTimer;
    let selectedMessages = new Set();
    let touchStartX = 0;
    let touchStartY = 0;
    
    function updateSelectionUI() {
        const toolbar = document.getElementById('multi-select-toolbar');
        const count = selectedMessages.size;
        
        if (count > 0) {
            toolbar.classList.remove('hidden');
            document.getElementById('selected-count').textContent = `${count} selected`;
        } else {
            toolbar.classList.add('hidden');
        }
    }
    
    function clearSelection() {
        selectedMessages.forEach(msgId => {
            const msgElement = document.getElementById(`msg-${msgId}`);
            if (msgElement) {
                msgElement.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
            }
        });
        selectedMessages.clear();
        updateSelectionUI();
        closeAllMenus();
    }
    
    function startLongPress(event, msgId, senderId, currentUserId) {
        if (window.innerWidth >= 768) return; // Desktop uses right-click instead
        
        // Record touch start position for swipe detection
        const touch = event.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        
        longPressTimer = setTimeout(() => {
            showMobileMenu(event, msgId, senderId, currentUserId);
        }, 500);
    }
    
    function cancelLongPress() {
        clearTimeout(longPressTimer);
    }
    
    // Swipe-to-Reply Detection (Mobile only)
    function handleTouchMove(event, msgId, senderId, currentUserId) {
        const touch = event.touches[0];
        const touchEndX = touch.clientX;
        const touchEndY = touch.clientY;
        
        // Calculate swipe distance (left to right for reply)
        const swipeDistance = touchEndX - touchStartX;
        const verticalDistance = Math.abs(touchEndY - touchStartY);
        
        // Detect left-to-right swipe (50px minimum)
        if (swipeDistance > 50 && verticalDistance < 30) {
            clearTimeout(longPressTimer);
            const msgElement = document.getElementById(`msg-${msgId}`);
            if (msgElement) {
                // Visual feedback
                msgElement.style.transform = 'translateX(10px)';
                setTimeout(() => {
                    msgElement.style.transform = 'translateX(0)';
                }, 200);
                
                // Trigger reply
                setReply(msgId, document.getElementById(`msg-${msgId}`).getAttribute('data-message-text'));
                showToast('‚Ü©Ô∏è Reply mode activated', 'blue');
            }
        }
    }
    
    function showContextMenu(event, msgId, senderId, currentUserId) {
        event.preventDefault();
        closeAllMenus();
        
        const msgElement = document.getElementById(`msg-${msgId}`);
        if (!msgElement) return;
        
        const rect = msgElement.getBoundingClientRect();
        const menu = document.createElement('div');
        menu.className = 'fixed bg-white rounded-lg shadow-xl border border-gray-200 z-50 animate-fade-in';
        menu.id = 'context-menu';
        menu.style.left = event.clientX + 'px';
        menu.style.top = event.clientY + 'px';
        
        const isOwner = senderId == currentUserId;
        const msgText = msgElement.getAttribute('data-message-text');
        
        menu.innerHTML = `
            <div class="py-2 min-w-max">
                <button onclick="toggleSelectMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-check-square text-indigo-600 w-4"></i> Select
                </button>
                <button onclick="copyMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-copy text-blue-600 w-4"></i> Copy
                </button>
                <button onclick="setReply('${msgId}', '${msgText.replace(/'/g, "\\'")}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-reply text-green-600 w-4"></i> Reply
                </button>
                <button onclick="showSimpleInfo('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-info-circle text-blue-600 w-4"></i> Info
                </button>
                <button onclick="pinMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-thumbtack text-amber-600 w-4"></i> Pin
                </button>
                <button onclick="forwardMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-share text-green-600 w-4"></i> Forward
                </button>
                ${isOwner ? `
                <div class="border-t border-gray-200 my-1"></div>
                <button onclick="deleteMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                    <i class="fas fa-trash w-4"></i> Delete
                </button>
                ` : ''}
            </div>
        `;
        
        document.body.appendChild(menu);
        
        // Close on outside click
        setTimeout(() => {
            document.addEventListener('click', closeContextMenu);
        }, 0);
    }
    
    function showMobileMenu(event, msgId, senderId, currentUserId) {
        const msgElement = document.getElementById(`msg-${msgId}`);
        if (!msgElement) return;
        
        const rect = msgElement.getBoundingClientRect();
        const menu = document.createElement('div');
        menu.className = 'fixed bg-white rounded-lg shadow-xl border border-gray-200 z-50 animate-slide-up';
        menu.id = 'mobile-menu';
        
        const isOwner = senderId == currentUserId;
        const msgText = msgElement.getAttribute('data-message-text');
        
        menu.innerHTML = `
            <div class="py-2 min-w-max">
                <button onclick="toggleSelectMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-check-square text-indigo-600 w-4"></i> Select
                </button>
                <button onclick="copyMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-copy text-blue-600 w-4"></i> Copy
                </button>
                <button onclick="setReply('${msgId}', '${msgText.replace(/'/g, "\\'")}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-reply text-green-600 w-4"></i> Reply
                </button>
                <button onclick="showSimpleInfo('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-info-circle text-blue-600 w-4"></i> Info
                </button>
                <button onclick="pinMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-thumbtack text-amber-600 w-4"></i> Pin
                </button>
                <button onclick="forwardMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                    <i class="fas fa-share text-green-600 w-4"></i> Forward
                </button>
                ${isOwner ? `
                <div class="border-t border-gray-200 my-1"></div>
                <button onclick="deleteMessage('${msgId}')" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                    <i class="fas fa-trash w-4"></i> Delete
                </button>
                ` : ''}
            </div>
        `;
        
        // Position at bottom center on mobile
        menu.style.bottom = '100px';
        menu.style.left = '50%';
        menu.style.transform = 'translateX(-50%)';
        menu.style.maxWidth = '85vw';
        
        document.body.appendChild(menu);
        
        setTimeout(() => {
            document.addEventListener('click', closeMobileMenu);
        }, 0);
    }
    
    function closeContextMenu() {
        const menu = document.getElementById('context-menu');
        if (menu) menu.remove();
        document.removeEventListener('click', closeContextMenu);
    }
    
    function closeMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        if (menu) menu.remove();
        document.removeEventListener('click', closeMobileMenu);
    }
    
    function closeAllMenus() {
        closeContextMenu();
        closeMobileMenu();
    }
    
    function toggleSelectMessage(msgId) {
        const msgElement = document.getElementById(`msg-${msgId}`);
        if (!msgElement) return;
        
        if (selectedMessages.has(msgId)) {
            selectedMessages.delete(msgId);
            msgElement.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50');
        } else {
            selectedMessages.add(msgId);
            msgElement.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
        }
        updateSelectionUI();
        closeAllMenus();
    }
    
    function copyMessage(msgId) {
        const msgElement = document.getElementById(`msg-${msgId}`);
        if (!msgElement) return;
        
        const msgText = msgElement.getAttribute('data-message-text');
        if (!msgText) return;
        
        navigator.clipboard.writeText(msgText).then(() => {
            showToast('‚úì Message copied to clipboard', 'green');
            closeAllMenus();
        }).catch(() => {
            showToast('‚ùå Failed to copy message', 'red');
        });
    }
    
    function deleteConversation() {
        const confirmed = confirm('Delete this entire conversation? This action cannot be undone.');
        if (confirmed) {
            fetch(`/api/delete-chat/{{ chat.id }}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    showToast('‚úì Chat deleted', 'green');
                    setTimeout(() => window.location.href = '/', 1000);
                } else {
                    showToast('‚ùå Failed to delete chat', 'red');
                }
            });
        }
        closeAllMenus();
    }
    
    function deleteSelectedMessages() {
        if (selectedMessages.size === 0) {
            showToast('‚ùå No messages selected', 'red');
            return;
        }
        
        const confirmed = confirm(`Delete ${selectedMessages.size} message(s)? This action cannot be undone.`);
        if (confirmed) {
            fetch('/api/bulk-delete-messages/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message_ids: Array.from(selectedMessages) })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    selectedMessages.forEach(msgId => {
                        const msgElement = document.getElementById(`msg-${msgId}`);
                        if (msgElement) {
                            msgElement.style.opacity = '0.5';
                            msgElement.innerHTML = '<div class="text-xs text-gray-400 italic px-4 py-2">Message deleted</div>';
                        }
                    });
                    clearSelection();
                    showToast(data.message, 'green');
                } else {
                    showToast('‚ùå ' + data.error, 'red');
                }
            }).catch(err => showToast('‚ùå Error: ' + err.message, 'red'));
        }
    }
    
    function openForwardDialog() {
        const dialog = document.getElementById('forward-dialog');
        const listDiv = document.getElementById('forward-contacts-list');
        
        // Fetch user's contacts
        fetch('/api/get-contacts/')
            .then(res => res.json())
            .then(data => {
                if (data.contacts && data.contacts.length > 0) {
                    listDiv.innerHTML = data.contacts.map(contact => `
                        <button onclick="forwardToContact('${contact.chat_id}')" class="w-full p-3 text-left bg-gray-50 hover:bg-indigo-50 rounded-lg border border-gray-200 hover:border-indigo-300 transition">
                            <div class="font-medium text-gray-800">${contact.name}</div>
                            <div class="text-xs text-gray-500">${contact.mobile}</div>
                        </button>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No contacts available</p>';
                }
            })
            .catch(err => {
                listDiv.innerHTML = '<p class="text-red-500 text-center py-4">Error loading contacts</p>';
            });
        
        dialog.classList.remove('hidden');
    }
    
    function closeForwardDialog() {
        document.getElementById('forward-dialog').classList.add('hidden');
    }
    
    function forwardToContact(targetChatId) {
        if (selectedMessages.size === 0) {
            showToast('‚ùå No messages selected', 'red');
            return;
        }
        
        fetch('/api/bulk-forward-messages/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message_ids: Array.from(selectedMessages),
                target_chat_id: targetChatId
            })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                clearSelection();
                closeForwardDialog();
                showToast(data.message, 'green');
            } else {
                showToast('‚ùå ' + data.error, 'red');
            }
        }).catch(err => showToast('‚ùå Error: ' + err.message, 'red'));
    }
    
    function forwardMessage(msgId) {
        selectedMessages.clear();
        selectedMessages.add(msgId);
        updateSelectionUI();
        openForwardDialog();
    }

    function deleteMessage(msgId) {
        const confirmed = confirm('Are you sure you want to delete this message?');
        if (confirmed) {
            if (window.chatSocket && window.chatSocket.readyState === WebSocket.OPEN) {
                window.chatSocket.send(JSON.stringify({
                    type: 'delete_message',
                    message_id: msgId,
                    user_id: currentUserId
                }));
                const msgElement = document.getElementById(`msg-${msgId}`);
                if (msgElement) {
                    msgElement.style.opacity = '0.5';
                    msgElement.innerHTML = '<div class="text-xs text-gray-400 italic px-4 py-2">Message deleted</div>';
                }
                showToast('‚úì Message deleted', 'green');
            }
        }
        closeAllMenus();
    }
    
    function pinMessage(msgId) {
        showToast('‚úì Message pinned', 'green');
        closeAllMenus();
    }
    
    function searchMessages() {
        showToast('Search feature coming soon', 'green');
        closeAllMenus();
    }
    
    function showSimpleInfo(msgId) {
        const msgElement = document.getElementById(`msg-${msgId}`);
        if (!msgElement) return;
        
        const timeEl = msgElement.querySelector('.text-\\[10px\\].text-gray-400');
        const sentTime = timeEl ? timeEl.textContent.trim() : 'Unknown';
        
        const readIcon = msgElement.querySelector('.fa-check-double');
        const isRead = readIcon ? readIcon.classList.contains('text-blue-500') : false;
        const readTime = isRead ? 'Read' : 'Not Read';
        
        // Simulated online status (can be enhanced with real user status)
        const onlineStatus = 'Online';
        
        const infoBox = document.createElement('div');
        infoBox.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50';
        infoBox.onclick = () => infoBox.remove();
        
        infoBox.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg p-4 max-w-sm mx-4 animate-fade-in" onclick="event.stopPropagation()">
                <h3 class="font-bold text-gray-800 mb-4">Message Info</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center pb-2 border-b">
                        <span class="text-gray-600"><i class="fas fa-clock text-blue-600 mr-2 w-4"></i>Sent</span>
                        <span class="font-medium text-gray-800">${sentTime}</span>
                    </div>
                    <div class="flex justify-between items-center pb-2 border-b">
                        <span class="text-gray-600"><i class="fas fa-check-double text-indigo-600 mr-2 w-4"></i>Read Status</span>
                        <span class="font-medium ${isRead ? 'text-green-600' : 'text-gray-400'}">${readTime}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600"><i class="fas fa-circle text-green-600 mr-2 w-4"></i>User Status</span>
                        <span class="font-medium text-green-600">${onlineStatus}</span>
                    </div>
                </div>
                <button onclick="this.closest('div').parentElement.remove()" class="w-full mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                    Close
                </button>
            </div>
        `;
        
        document.body.appendChild(infoBox);
        closeAllMenus();
    }
    
    function showToast(message, type = 'green') {
        const toast = document.createElement('div');
        let bgColor = 'bg-green-500';
        if (type === 'red') bgColor = 'bg-red-500';
        if (type === 'blue') bgColor = 'bg-blue-500';
        
        toast.className = `fixed bottom-20 left-1/2 -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }

    function scrollToMessage(msgId) {
        const element = document.getElementById(msgId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            element.classList.add('animate-pulse');
            setTimeout(() => element.classList.remove('animate-pulse'), 2000);
        }
    }

    // Add touch move handler for swipe-to-reply on all message items
    document.querySelectorAll('.message-item').forEach(item => {
        const msgId = item.getAttribute('data-message-id');
        const senderId = item.getAttribute('oncontextmenu').match(/'([^']*)',\s*'([^']*)',/)[2];
        const currentUserId = "{{ request.user.id }}";
        
        item.addEventListener('touchmove', (e) => {
            handleTouchMove(e, msgId, senderId, currentUserId);
        }, { passive: true });
    });

    // Global click handler for menus
    document.addEventListener('click', handleGlobalClick);
</script>